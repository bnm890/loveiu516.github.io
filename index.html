<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

    <title>RM輸入+查詢+外嵌</title>
    <link rel="icon" href="http://i.imgur.com/ufPgFO7.jpg">
    
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script> 
    <!-- bootstrap -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <!-- react -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.min.js"></script>
    <!-- babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
    <!-- react-bootstrap -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-bootstrap/0.28.3/react-bootstrap.min.js"></script>
  </head>

  <body>
    
    <div id = "main"></div>


    <script type="text/babel">
    var Grid=ReactBootstrap.Grid;
    var Row=ReactBootstrap.Row;
    var Col=ReactBootstrap.Col;

    var ButtonsInstance = ReactBootstrap.ButtonsInstance;
    var ButtonToolbar = ReactBootstrap.ButtonToolbar;
    var ButtonInput = ReactBootstrap.ButtonInput;
    var Button = ReactBootstrap.Button;
 
    var Label = ReactBootstrap.Label;
    var Input = ReactBootstrap.Input;
    var Tabs = ReactBootstrap.Tabs;
    var Tab = ReactBootstrap.Tab;
    var Image = ReactBootstrap.Image;
    var Glyphicon=ReactBootstrap.Glyphicon;
    var Jumbotron=ReactBootstrap.Jumbotron;
    var Pager=ReactBootstrap.Pager;
    var Panel=ReactBootstrap.Panel;

    var text0=0;
    var text1="";
    var text2="";
    var text3="";
    var text4="";
    var openload, videomega, openloadpart1, openloadpart2;


    var sendurl = "https://script.google.com/macros/s/AKfycbxQJg6qr2aGeQOmmhTSTp9Zfl-N4yBG3InTYsV3DoLCjd6f11M_/exec";


      var Reloadbtn = React.createClass({
        render() {
          return (
            <Row className="well">
            <Button bsStyle="primary" bsSize="large" block href="javascript:history.go(0)">送出成功</Button>
            </Row>
          );
        }
      });


      var QueryResult = React.createClass ({
        render() {
          return (
            <Row className="well">
            <h1><Label bsStyle="danger" >集數 : {this.props.no}</Label></h1>
            <h1><Label bsStyle="success" >openload : <a href={this.props.openload} target="_blank">{this.props.openload}</a></Label></h1>
            <h1><Label bsStyle="success" >videomega : <a href={this.props.videomega} target="_blank">{this.props.videomega}</a></Label></h1>
            <h1><Label bsStyle="success" >openload part1 : <a href={this.props.openloadpart1} target="_blank">{this.props.openloadpart1}</a></Label></h1>
            <h1><Label bsStyle="success" >openload part2 : <a href={this.props.openloadpart2} target="_blank">{this.props.openloadpart2}</a></Label></h1>
            </Row>
          );
        }
      });

      var Embed = React.createClass ({
        render() {
          var openembed="https://openload.co/embed"+(openload.slice(21));
          return (
            <Row className="well">
            <Pager>
            <Panel header=<h0>RM 第{text0}集</h0> bsStyle="info">
            <iframe src={openembed} scrolling="no" frameborder="0" width="100%" height="500" allowfullscreen="true" webkitallowfullscreen="true" mozallowfullscreen="true"></iframe>
            </Panel>
            </Pager>
            </Row>
          );
        }
      });


      var Input1 = React.createClass ({

          getresult() {
          if ((Number(this.refs.text0.getValue()) != 0)&&(isNaN(this.refs.text0.getValue()) != true)) {            
          text0 = Number(this.refs.text0.getValue());
          var jsonURL = "https://spreadsheets.google.com/feeds/list/1VSNCsTA68lUmYqwRPbeeE9eaaj5PQyvqeJM6ve5Pi5k/1/public/values?sq=no="+text0+"&alt=json";
            $.ajax({
            url: jsonURL,
            global: false,
            type: 'GET',
            dataType: 'json',
            async: true,
              success: function(json) {
                var e = json.feed.entry;
                var l = e.length;
                var html = "";
                var i, entry, no;
                for (i = 0; i < l; i++) {
                entry = e[i];
                no = entry.gsx$no.$t;
                openload = entry.gsx$openload.$t;
                videomega = entry.gsx$videomega.$t;
                openloadpart1 = entry.gsx$openloadpart1.$t;
                openloadpart2 = entry.gsx$openloadpart2.$t;

                if (no==text0) {
                ReactDOM.render(<QueryResult no={no} openload={openload} videomega={videomega} openloadpart1={openloadpart1} openloadpart2={openloadpart2} />,result);
                ReactDOM.render(<Embed />, embed);
                }
                
                }
              }
          });

        }else{
          ReactDOM.render(<div />, result);
          ReactDOM.render(<div />, embed);
          ReactDOM.render(<div />, input1);
          ReactDOM.render(<Input1 />, input1);
        }
      },

        render() {
          return (
            <Input type="text" bsSize="large" ref="text0" onChange={this.getresult} addonBefore="集數" placeholder="集數" block></Input>
          );
        }
      });

    var ButtonInput = React.createClass({
      send() {
        if (String(text0)=="0"||String(text1)==String(text2)||String(text3)===String(text4)) {
        }else{
          $.ajax({
            url: sendurl,
            global: false,
            type: 'GET',
            dataType: 'json',
            data: {
              "text0": text0,
              "text1": text1,
              "text2": text2,
              "text3": text3,
              "text4": text4
              },
              async: true,
              success: function() {
              ReactDOM.render(<Reloadbtn />, reloadbtn);
              }
          });
        }
      },

      getvalue() {
        ReactDOM.render(<div />, reloadbtn);
        if (this.refs.text1.getValue() == "") {
          text1 = "";
        } else if (this.refs.text1.getValue() != "") {
          text1 = this.refs.text1.getValue();
        }
        if (this.refs.text2.getValue() == "") {
          text2 = "";
        } else if (this.refs.text2.getValue() != "") {
          text2 = this.refs.text2.getValue();
        }
        if (this.refs.text3.getValue() == "") {
          text3 = "";
        } else if (this.refs.text3.getValue() != "") {
          text3 = this.refs.text3.getValue();
        }
        if (this.refs.text4.getValue() == "") {
          text4 = "";
        } else if (this.refs.text4.getValue() != "") {
          text4 = this.refs.text4.getValue();
        }
      },


      render() {
        return (
        <Grid>
        <Row className="well">
              <Pager>
              <Panel header=<h0>RM輸入+查詢+外嵌</h0> bsStyle="info">
              <div id = "input1"></div>
              </Panel>
              </Pager>


            <form>
            <Col xs={12} md={12}>
              <Input type="text" bsSize="large" ref="text1" onChange={this.getvalue} addonBefore="Openload" placeholder="Openload"/>
            </Col>

            <Col xs={12} md={12}>
              <Input type="text" bsSize="large" ref="text2" onChange={this.getvalue} addonBefore="Videomega" placeholder="Videomega"/>
            </Col>

            <Col xs={12} md={12}>
              <Input type="text" bsSize="large" ref="text3" onChange={this.getvalue} addonBefore="Openload part1" placeholder="Openload part1"/>
            </Col>

            <Col xs={12} md={12}>
              <Input type="text" bsSize="large" ref="text4" onChange={this.getvalue} addonBefore="Openload part2" placeholder="Openload part2"/>
            </Col>

            <Col xs={9} md={9}>
              <Button bsStyle="primary" bsSize="large" onClick={this.send} block>送出</Button>
            </Col>
            <Col xs={3} md={3}>
              <Button type="reset"  bsStyle="primary" bsSize="large" bsStyle="danger" block>清除</Button>
            </Col>
            </form>

          </Row>

            <Row>
            <Col xs={12} md={12}>
              <div id = "reloadbtn"></div>

              <div id = "result"></div>

              <div id = "embed"></div>
            </Col>

        </Row>
        </Grid>
        );
      }
    });
    ReactDOM.render(<ButtonInput />, main);
    ReactDOM.render(<Input1 />, input1);



    </script>
  </body>
</html>